<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown看板</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7f9;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .instructions {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            border-left: 4px solid #3498db;
        }

        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }

        /* 改进看板容器 */
        .kanban-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 5px 25px 5px;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
            min-height: 500px;
            align-items: flex-start;
            width: 100%;
            position: relative; /* 新增：为滚动提示提供定位上下文 */
        }

        /* Webkit浏览器滚动条样式 */
        .kanban-container::-webkit-scrollbar {
            height: 12px;
        }

        .kanban-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .kanban-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .kanban-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* 改进列布局 */
        .column {
            flex: 0 0 320px;
            min-width: 280px;
            max-width: 400px;
            background-color: #e6e9ed;
            border-radius: 10px;
            padding: 15px;
            min-height: 500px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            height: fit-content;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ccc;
        }

        .column-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2c3e50;
            padding: 5px 10px;
            border-radius: 4px;
            width: 70%;
        }

        .column-title:focus {
            outline: 2px solid #3498db;
            background-color: #f8f9fa;
        }

        /* 统一删除按钮样式 */
        .delete-btn {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            border: none;
            border-radius: 5px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .delete-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            transform: scale(1.1);
        }

        .delete-btn i {
            font-size: 18px;
        }

        /* 更新卡片操作按钮样式 */
        .card-actions .delete-btn {
            width: auto;
            height: auto;
            padding: 5px;
            margin: 0;
            background: none;
        }

        .card-actions .delete-btn:hover {
            background: rgba(231, 76, 60, 0.1);
            transform: scale(1);
        }

        /* 更新子任务删除按钮样式 */
        .subtask-actions .delete-btn {
            width: 30px;
            height: 30px;
            padding: 5px;
        }

        /* 黑暗模式适配 */
        body.dark-mode .delete-btn {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        body.dark-mode .delete-btn:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        body.dark-mode .card-actions .delete-btn:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            cursor: move;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            padding-left: 45px; /* 增加左侧内边距，为checkbox留出空间 */
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: bold;
            font-size: 1.1rem;
            flex: 1;
            margin-right: 10px;
            white-space: nowrap;        /* 防止换行 */
            overflow: hidden;           /* 隐藏溢出内容 */
            text-overflow: ellipsis;    /* 显示省略号 */
            max-width: 200px;           /* 设置最大宽度 */
        }

        /* 统一表单元素样式 */
        .card-title-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .card-content {
            min-height: 40px;
            margin-bottom: 10px;
            color: #555;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .card-actions button {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #7f8c8d;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .card-actions button:hover {
            color: #2c3e50;
            background: #f5f7f9;
        }

        .add-card-form {
            margin-top: 10px;
            display: none;
        }

        .add-card-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .add-card-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* 美化表单按钮 */
        .add-card-form-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .add-card-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }

        .add-card-btn:hover {
            background: #2980b9;
        }

        .add-card-form-actions .add-btn {
            background: #2ecc71;
            color: white;
        }

        .add-card-form-actions .add-btn:hover {
            background: #27ae60;
        }

        .add-card-form-actions .cancel-btn {
            background: #e74c3c;
            color: white;
        }

        .add-card-form-actions .cancel-btn:hover {
            background: #c0392b;
        }

        .add-column {
            flex: 0 0 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #add-column-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        #add-column-btn:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        /* 自定义输入模态框样式 */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .custom-modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .custom-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .custom-modal-body {
            margin-bottom: 20px;
        }

        .custom-modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .custom-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .custom-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .custom-modal-confirm {
            background: #2ecc71;
            color: white;
        }

        .custom-modal-cancel {
            background: #e74c3c;
            color: white;
        }

        .close {
            font-size: 1.8rem;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.2s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .card-detail-view {
            margin-bottom: 20px;
        }

        /* 确保卡片详情中的标题完整显示 */
        .card-detail-title {
            flex: 1;
            min-height: 40px;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            word-wrap: break-word;      /* 允许长单词换行 */
            white-space: normal;        /* 允许正常换行 */
        }

        .card-detail-title-container {
            position: relative;
            padding-left: 40px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-detail-title-container .card-checkbox-label {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
        }

        .card-detail-content {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            min-height: 100px;
        }

        .card-detail-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .detail-action-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .detail-action-btn:hover {
            background: #e0e0e0;
        }

        .subtasks-section {
            margin-bottom: 20px;
        }

        .subtasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .subtask {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .subtask:last-child {
            border-bottom: none;
        }

        .subtask-checkbox {
            display: none;
        }

        .subtask-checkbox-label {
            width: 18px;
            height: 18px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
            transition: all 0.2s ease;
        }

        .subtask-checkbox-label.checked {
            background: #2ecc71;
            border-color: #2ecc71;
        }

        .subtask-checkbox-label.checked::after {
            content: '';
            display: block;
            margin-left: 5px;
            margin-top: 2px;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .subtask-content {
            flex: 1;
        }

        .subtask-actions {
            display: flex;
            gap: 5px;
        }

        .progress-bar {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #2ecc71;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: right;
        }

        .edit-mode {
            display: none;
        }

        .edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .edit-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        #save-edit {
            background: #2ecc71;
            color: white;
        }

        #cancel-edit {
            background: #e74c3c;
            color: white;
        }

        .format-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .format-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .format-btn:hover {
            background: #e8f4fc;
            border-color: #3498db;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .time-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .time-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #666;
        }
        
        .time-input-group {
            flex: 1;
        }

        .week-day {
            font-weight: bold;
            background: #f5f7f9;
        }

        .datetime-picker {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .datetime-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            justify-content: space-between;
            flex-wrap: nowrap;
        }
        
        .datetime-label {
            min-width: 40px;
            font-weight: 500;
            color: #555;
        }
        
        .datetime-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .datetime-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 60px;
        }

        .datetime-input-group label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-bottom: 5px;
        }

        .datetime-input {
            width: 70px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .datetime-dropdown {
            position: relative;
            display: block;
        }

        .datetime-dropdown-btn {
            padding: 8px 5px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .datetime-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            left: 0;
            right: 0;
        }

        .datetime-dropdown-content div {
            padding: 8px 5px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
        }

        .datetime-dropdown-content div:hover {
            background-color: #f0f0f0;
        }

        .datetime-dropdown:hover .datetime-dropdown-content {
            display: block;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            font-family: 'Courier New', monospace;
            line-height: 1.5;
        }

        .markdown-preview {
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            background: #f8f9fa;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .dragging {
            opacity: 0.6;
            transform: rotate(5deg);
        }

        #drag-mirror {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .dropzone {
            background-color: rgba(46, 204, 113, 0.2);
            min-height: 100px;
            border: 2px dashed #2ecc71;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .drop-indicator {
            height: 4px;
            background-color: #2ecc71;
            border-radius: 2px;
            margin: 5px 0;
            opacity: 0.8;
        }

        .file-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .file-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #save-file {
            background: #2ecc71;
            color: white;
        }

        #save-file:hover {
            background: #27ae60;
            transform: translateY(-2px);
        }

        #load-file {
            background: #3498db;
            color: white;
        }

        #load-file:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        #file-input {
            display: none;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .completed {
            opacity: 0.7;
            background-color: #f8fff8;
        }

        .completed .card-title {
            text-decoration: line-through;
        }

        .card-checkbox {
            display: none;
        }

        .card-checkbox-label {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card-checkbox-label.checked {
            background: #2ecc71;
            border-color: #2ecc71;
        }

        .card-checkbox-label.checked::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .tags-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: white;
        }

        /* 标签选择器样式 */
        .tag-colors {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .tag-color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 3px solid transparent;
        }

        .tag-color-option:hover {
            transform: scale(1.1);
        }

        .tag-color-option.selected {
            border-color: #2c3e50;
            transform: scale(1.1);
        }

        .tag-text-input {
            margin: 20px 0;
        }

        .tag-text-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* 更新标签显示样式 */
        .tag {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            color: white;
            margin-right: 5px;
            display: inline-block;
        }

        .tag-red { background: #e74c3c; }
        .tag-orange { background: #f39c12; }
        .tag-yellow { background: #f1c40f; color: #2c3e50; }
        .tag-green { background: #2ecc71; }
        .tag-blue { background: #3498db; }
        .tag-purple { background: #9b59b6; }
        .tag-gray { background: #95a5a6; }

        /* 添加对应的CSS样式 */
        .subtask-status {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .due-date {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .due-date.overdue {
            color: #e74c3c;
            font-weight: bold;
        }

        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .confirmation-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .confirmation-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .confirmation-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .confirm-btn {
            background: #2ecc71;
            color: white;
        }

        .cancel-btn {
            background: #e74c3c;
            color: white;
        }

        /* 提醒样式 */
        .reminder {
            font-size: 0.9rem;
            margin: 5px 0;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .reminder-blue {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
        }

        .reminder-orange {
            background-color: #fff7e6;
            color: #fa8c16;
            border: 1px solid #ffd591;
        }

        .reminder-red {
            background-color: #fff2f0;
            color: #f5222d;
            border: 1px solid #ffccc7;
        }

        .card-overdue {
            border: 2px solid #f5222d !important;
            box-shadow: 0 0 8px rgba(245, 34, 45, 0.4) !important;
        }

        .overdue-text {
            font-weight: bold;
            font-size: 1.05em;
            text-decoration: underline;
        }

        /* 小屏幕设备上的标题处理 */
        @media (max-width: 480px) {
            .card-title {
                max-width: 150px;
            }
            
            .card-detail-title {
                font-size: 1.3rem;
            }
        }

        /* 中等屏幕设备 */
        @media (min-width: 481px) and (max-width: 768px) {
            .card-title {
                max-width: 180px;
            }
        }

        /* 大屏幕设备 */
        @media (min-width: 1200px) {
            .card-title {
                max-width: 250px;
            }
        }

        /* 添加导航按钮样式 */
        .scroll-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .scroll-left {
            left: 10px;
        }

        .scroll-right {
            right: 10px;
        }

        .scroll-btn:hover {
            background: #f0f0f0;
            transform: translateY(-50%) scale(1.1);
        }

        /* 简化媒体查询 - 移除重复定义，只保留一个权威版本 */
        @media (max-width: 768px) {
            .kanban-container {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
                padding: 10px;
            }
            
            .column {
                width: 100%;
                min-width: unset;
                max-width: unset;
                max-height: unset;
                margin-bottom: 20px;
                flex: 1;
            }
            
            .add-column {
                width: 100%;
                flex: 1;
                margin-top: 20px;
            }

            .file-actions {
                flex-direction: column;
                gap: 15px;
            }

            .scroll-btn {
                display: none !important;
            }
        }

        @media (min-width: 769px) and (max-height: 600px) {
            .kanban-container {
                max-height: 70vh;
            }
            
            .column {
                max-height: 65vh;
            }
        }

        @media (min-width: 1200px) {
            .kanban-container {
                justify-content: center;
            }
            
            .column {
                flex: 0 0 350px;
            }
        }

        /* 当列太多时自动调整列宽 */
        @media (min-width: 1600px) {
            .column {
                flex: 1;
                min-width: 250px;
                max-width: 350px;
            }
        }

        /* 中等屏幕调整 */
        @media (max-width: 1200px) {
            .column {
                flex: 0 0 300px;
                min-width: 250px;
            }
        }

        /* 小屏幕调整 */
        @media (max-width: 900px) {
            .column {
                flex: 0 0 280px;
                min-width: 220px;
            }
        }

        /* 移动端优化 */
/*        @media (max-width: 768px) {
            .kanban-container {
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
                padding: 10px;
            }
            
            .column {
                width: 100%;
                flex: 1;
                min-width: unset;
                max-width: unset;
                max-height: unset;
                margin-bottom: 20px;
            }
        }*/

        /* 添加列按钮样式优化 */
        .add-column {
            flex: 0 0 200px;
            min-width: 180px;
        }

        /* 滚动提示 */
        .kanban-container::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, rgba(0,0,0,0.1));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .kanban-container.scrollable::after {
            opacity: 1;
        }

        /* 黑暗模式样式 */
        body.dark-mode {
            background-color: #1e1e1e;
            color: #d4d4d4;
        }

        body.dark-mode header {
            background: linear-gradient(135deg, #3c3c3c 0%, #2d2d30 100%);
        }

        body.dark-mode .instructions {
            background-color: #2d2d30;
            border-left: 4px solid #4ec9b0;
        }

        body.dark-mode .column {
            background-color: #252526;
        }

        body.dark-mode .column-title {
            color: #d4d4d4;
        }

        body.dark-mode .column-title:focus {
            background-color: #3c3c3c;
        }

        body.dark-mode .card {
            background: #2d2d30;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .card-actions button:hover {
            color: #d4d4d4;
            background: #3c3c3c;
        }

        body.dark-mode .modal-content {
            background: #2d2d30;
            color: #d4d4d4;
        }

        body.dark-mode textarea {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
        }

        body.dark-mode .format-toolbar {
            background: #252526;
        }

        body.dark-mode .format-btn {
            background: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #4ec9b0;
        }

        body.dark-mode .format-btn:hover {
            background: #4ec9b0;
            color: #1e1e1e;
        }

        body.dark-mode .markdown-preview {
            background: #252526;
            border: 1px solid #3c3c3c;
            color: #d4d4d4;
        }

        body.dark-mode .completed {
            background-color: #1e2e1e;
        }

        /* 黑暗模式适配 */
        body.dark-mode .datetime-dropdown-btn {
            background: #3c3c3c;
            color: #d4d4d4;
            border-color: #4ec9b0;
        }

        body.dark-mode .datetime-dropdown-content {
            background: #2d2d30;
            border-color: #4ec9b0;
        }

        body.dark-mode .datetime-dropdown-content div:hover {
            background-color: #3c3c3c;
        }

        /* 黑暗模式适配 */
        body.dark-mode .custom-modal-content {
            background: #2d2d30;
            color: #d4d4d4;
        }

        body.dark-mode .custom-modal-input {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3c3c3c;
        }

        body.dark-mode .calendar-cell:hover {
            background: #3c3c3c;
        }

        body.dark-mode .week-day {
            background: #252526;
        }

        /* 黑暗模式切换按钮 */
        .theme-switch {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-switch-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        body.dark-mode .theme-switch-btn {
            background: #4ec9b0;
        }

        .theme-switch-btn:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .theme-switch {
                bottom: 70px;
                right: 15px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1><i class="ri-layout-column-line"></i> Markdown看板</h1>
        <!-- <p>增强版本地看板应用 - 支持标签、时间戳和子任务</p> -->
    </header>

    <div class="instructions">
        <p><strong>使用说明：</strong></p>
        <ul>
            <li>点击"添加卡片"按钮直接在当前列创建卡片</li>
            <li>悬停卡片时右上角显示完成状态复选框</li>
            <li>点击卡片进入查看模式，可添加标签、设置到期时间和子任务</li>
            <li>右下角按钮切换黑暗模式</li>
        </ul>
    </div>

    <div class="kanban-container" id="kanban-container">
        <!-- 列将通过JavaScript动态添加 -->
    </div>

    <div class="file-actions">
        <button id="save-file">
            <i class="ri-save-line"></i> 保存到Markdown文件
        </button>
        <button id="load-file">
            <i class="ri-folder-open-line"></i> 从Markdown文件加载
        </button>
        <input type="file" id="file-input" accept=".md">
    </div>

    <!-- 卡片详情/编辑模态框 -->
    <div class="modal" id="card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"><i class="ri-edit-line"></i> 卡片详情</h2>
                <span class="close">&times;</span>
            </div>

            <div class="card-detail-view" id="card-detail-view">
                <div class="card-detail-title-container">
                    <label class="card-checkbox-label" id="card-detail-checkbox-label"></label>
                    <div class="card-detail-title" id="card-detail-title" contenteditable="true"></div>
                </div>

                <div class="tags-container" id="tags-container"></div>

                <div class="due-date" id="due-date-container"></div>

                <div class="subtasks-section">
                    <div class="subtasks-header">
                        <h3>子任务</h3>
                        <button class="detail-action-btn" id="add-subtask-btn">
                            <i class="ri-add-line"></i> 添加子任务
                        </button>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="subtask-progress"></div>
                    </div>
                    <div class="progress-text" id="subtask-progress-text"></div>
                    <div id="subtasks-list"></div>
                </div>

                <div class="card-detail-content" id="card-detail-content"></div>

                <div class="card-detail-actions">
                    <button class="detail-action-btn" id="add-tag-btn">
                        <i class="ri-price-tag-line"></i> 添加标签
                    </button>
                    <button class="detail-action-btn" id="set-due-date-btn">
                        <i class="ri-time-line"></i> 设置到期时间
                    </button>
                    <button class="detail-action-btn" id="edit-card-btn">
                        <i class="ri-edit-line"></i> 编辑卡片
                    </button>
                </div>
            </div>

            <div class="edit-mode" id="edit-mode">
                <div class="format-toolbar">
                    <button class="format-btn" data-prefix="**" data-suffix="**" title="加粗">
                        <i class="ri-bold"></i>
                    </button>
                    <button class="format-btn" data-prefix="*" data-suffix="*" title="斜体">
                        <i class="ri-italic"></i>
                    </button>
                    <button class="format-btn" data-prefix="`" data-suffix="`" title="代码">
                        <i class="ri-code-line"></i>
                    </button>
                    <button class="format-btn" data-prefix="# " data-suffix="" title="标题1">
                        H1
                    </button>
                    <button class="format-btn" data-prefix="## " data-suffix="" title="标题2">
                        H2
                    </button>
                </div>

                <textarea id="card-content-text" placeholder="输入卡片内容，支持Markdown语法..."></textarea>

                <div class="markdown-preview" id="markdown-preview">
                    <p>预览将显示在这里...</p>
                </div>

                <div class="edit-actions">
                    <button id="save-edit">
                        <i class="ri-check-line"></i> 保存
                    </button>
                    <button id="cancel-edit">
                        <i class="ri-close-line"></i> 取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 标签选择器模态框 -->
    <div class="modal" id="tag-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="ri-price-tag-line"></i> 选择标签</h2>
                <span class="close" id="close-tag-modal">&times;</span>
            </div>

            <div class="tag-colors">
                <div class="tag-color-option" data-color="red" style="background: #e74c3c;"></div>
                <div class="tag-color-option" data-color="orange" style="background: #f39c12;"></div>
                <div class="tag-color-option" data-color="yellow" style="background: #f1c40f;"></div>
                <div class="tag-color-option" data-color="green" style="background: #2ecc71;"></div>
                <div class="tag-color-option" data-color="blue" style="background: #3498db;"></div>
                <div class="tag-color-option" data-color="purple" style="background: #9b59b6;"></div>
                <div class="tag-color-option" data-color="gray" style="background: #95a5a6;"></div>
            </div>

            <div class="tag-text-input">
                <input type="text" id="tag-text" placeholder="输入标签文本（可选）">
            </div>

            <div class="custom-modal-actions modal-actions">
                <button id="confirm-tag" class="custom-modal-btn custom-modal-confirm">确认</button>
                <button id="cancel-tag" class="custom-modal-btn custom-modal-cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="confirmation-modal" id="confirmation-modal">
        <div class="confirmation-content">
            <h3 id="confirmation-message">确定要删除吗？</h3>
            <div class="confirmation-actions">
                <button class="confirm-btn" id="confirmation-confirm">确定</button>
                <button class="cancel-btn" id="confirmation-cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 自定义输入模态框 -->
    <div class="custom-modal" id="input-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2 id="input-modal-title">输入</h2>
                <span class="close" id="close-input-modal">&times;</span>
            </div>
            <div class="custom-modal-body">
                <input type="text" class="custom-modal-input" id="input-modal-field" placeholder="请输入内容">
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-confirm" id="input-modal-confirm">确认</button>
                <button class="custom-modal-btn custom-modal-cancel" id="input-modal-cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 日期选择模态框 -->
    <div class="custom-modal" id="date-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h2>选择日期和时间</h2>
                <span class="close" id="close-date-modal">&times;</span>
            </div>
            <div class="custom-modal-body">
                <div class="datetime-picker">
                    <div class="datetime-row">
                        <div class="datetime-input-group">
                            <label>年</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="year-dropdown-btn">2023</div>
                                <div class="datetime-dropdown-content" id="year-dropdown"></div>
                            </div>
                        </div>
                        <div class="datetime-input-group">
                            <label>月</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="month-dropdown-btn">01</div>
                                <div class="datetime-dropdown-content" id="month-dropdown"></div>
                            </div>
                        </div>
                        <div class="datetime-input-group">
                            <label>日</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="day-dropdown-btn">01</div>
                                <div class="datetime-dropdown-content" id="day-dropdown"></div>
                            </div>
                        </div>
                        <div class="datetime-input-group">
                            <label>时</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="hour-dropdown-btn">00</div>
                                <div class="datetime-dropdown-content" id="hour-dropdown"></div>
                            </div>
                        </div>
                        <div class="datetime-input-group">
                            <label>分</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="minute-dropdown-btn">00</div>
                                <div class="datetime-dropdown-content" id="minute-dropdown"></div>
                            </div>
                        </div>
                        <div class="datetime-input-group">
                            <label>秒</label>
                            <div class="datetime-dropdown">
                                <div class="datetime-dropdown-btn" id="second-dropdown-btn">00</div>
                                <div class="datetime-dropdown-content" id="second-dropdown"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-modal-actions">
                <button class="custom-modal-btn custom-modal-confirm" id="date-modal-confirm">确认</button>
                <button class="custom-modal-btn custom-modal-cancel" id="date-modal-cancel">取消</button>
            </div>
        </div>
    </div>

    <!-- 黑暗模式切换按钮 -->
    <div class="theme-switch">
        <button class="theme-switch-btn" id="theme-switch">
            <i class="ri-moon-line"></i>
        </button>
    </div>

    <footer>
        <p>基于Markdown的看板应用 | 支持标签、时间戳和子任务</p>
    </footer>

    <script>
        // ==================== DOMContentLoaded事件监听器 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 创建放置指示器
            function createDropIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'drop-indicator';
                return indicator;
            }

            // 移除所有放置指示器
            function removeAllDropIndicators() {
                document.querySelectorAll('.drop-indicator').forEach(indicator => {
                    indicator.remove();
                });
            }

            // ==================== 初始示例数据 ====================
            const initialData = [
                {
                    title: '待处理',
                    cards: [
                        { 
                            title: '任务1',
                            content: '- 这是待处理的任务',
                            completed: false,
                            tags: [{color: 'red', text: '高优先级'}],
                            dueDate: null,
                            subtasks: [
                                { title: '子任务1', completed: false },
                                { title: '子任务2', completed: true }
                            ]
                        },
                        { 
                            title: '任务2',
                            content: '- 另一个待办事项',
                            completed: false,
                            tags: [{color: 'orange', text: '中优先级'}],
                            dueDate: '2023-12-31',
                            subtasks: []
                        }
                    ]
                },
                {
                    title: '进行中',
                    cards: [
                        { 
                            title: '任务3',
                            content: '- 正在进行的任务',
                            completed: false,
                            tags: [{color: 'green', text: '低优先级'}],
                            dueDate: null,
                            subtasks: []
                        },
                        { 
                            title: '任务4',
                            content: '- 另一个进行中的任务',
                            completed: false,
                            tags: [{color: 'blue', text: '功能开发'}],
                            dueDate: '2023-12-15',
                            subtasks: [
                                { title: '设计阶段', completed: true },
                                { title: '开发阶段', completed: false },
                                { title: '测试阶段', completed: false }
                            ]
                        }
                    ]
                },
                {
                    title: '已完成',
                    cards: [
                        { 
                            title: '任务5',
                            content: '- 已完成的任务',
                            completed: true,
                            tags: [{color: 'gray', text: '已完成'}],
                            dueDate: '2023-11-30',
                            subtasks: []
                        },
                        { 
                            title: '任务6',
                            content: '- 另一个已完成的任务\n- 包含多个子任务',
                            completed: true,
                            tags: [{color: 'purple', text: '项目交付'}],
                            dueDate: '2023-11-25',
                            subtasks: [
                                { title: '需求分析', completed: true },
                                { title: '功能开发', completed: true },
                                { title: '测试验证', completed: true },
                                { title: '文档编写', completed: true }
                            ]
                        }
                    ]
                }
            ];

            // ==================== 标签选择器功能 ====================
            let selectedColor = null;

            // 添加标签按钮点击事件
            document.getElementById('add-tag-btn').addEventListener('click', () => {
                document.getElementById('tag-modal').style.display = 'flex';
                selectedColor = null;
                document.querySelectorAll('.tag-color-option').forEach(option => {
                    option.classList.remove('selected');
                });
                document.getElementById('tag-text').value = '';
            });

            // 标签颜色选项点击事件
            document.querySelectorAll('.tag-color-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectedColor = option.dataset.color;
                    document.querySelectorAll('.tag-color-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                });
            });

            // 确认标签按钮点击事件
            document.getElementById('confirm-tag').addEventListener('click', () => {
                if (selectedColor) {
                    const tagText = document.getElementById('tag-text').value.trim();
                    const tagLabel = tagText || (selectedColor === 'red' ? '高优先级' : 
                                            selectedColor === 'orange' ? '中优先级' : 
                                            selectedColor === 'yellow' ? '低优先级' : 
                                            selectedColor);

                    if (!currentCard.tags) currentCard.tags = [];
                    currentCard.tags.push({
                        color: selectedColor,
                        text: tagLabel
                    });

                    saveData();
                    renderTags();
                    document.getElementById('tag-modal').style.display = 'none';
                }
            });

            // 取消标签按钮点击事件
            document.getElementById('cancel-tag').addEventListener('click', () => {
                document.getElementById('tag-modal').style.display = 'none';
            });

            // 关闭标签模态框按钮点击事件
            document.getElementById('close-tag-modal').addEventListener('click', () => {
                document.getElementById('tag-modal').style.display = 'none';
            });

            // ==================== 数据管理 ====================
            let kanbanData = JSON.parse(localStorage.getItem('kanbanData')) || initialData;
            let currentCard = null;
            let currentColumnIndex = -1;
            let currentCardIndex = -1;

            // 保存数据到本地存储
            function saveData() {
                localStorage.setItem('kanbanData', JSON.stringify(kanbanData));
            }

            // ==================== 自定义输入模态框功能 ====================
            let inputModalResolve = null;
            const inputModal = document.getElementById('input-modal');
            const inputModalField = document.getElementById('input-modal-field');
            const inputModalTitle = document.getElementById('input-modal-title');

            // 显示自定义输入模态框的函数
            function showInputModal(title, defaultValue = '') {
                return new Promise((resolve) => {
                    inputModalResolve = resolve;
                    inputModalTitle.textContent = title;
                    inputModalField.value = defaultValue;
                    inputModal.style.display = 'flex';
                    inputModalField.focus();
                });
            }

            // 确认输入按钮点击事件
            document.getElementById('input-modal-confirm').addEventListener('click', () => {
                if (inputModalResolve) {
                    inputModalResolve(inputModalField.value);
                    inputModalResolve = null;
                }
                inputModal.style.display = 'none';
            });

            // 取消输入按钮点击事件
            document.getElementById('input-modal-cancel').addEventListener('click', () => {
                if (inputModalResolve) {
                    inputModalResolve(null);
                    inputModalResolve = null;
                }
                inputModal.style.display = 'none';
            });

            // 关闭输入模态框按钮点击事件
            document.getElementById('close-input-modal').addEventListener('click', () => {
                if (inputModalResolve) {
                    inputModalResolve(null);
                    inputModalResolve = null;
                }
                inputModal.style.display = 'none';
            });

            // ==================== 日期时间选择器功能 ====================
            let dateModalResolve = null;
            const dateModal = document.getElementById('date-modal');
            let selectedDate = null;

            // 初始化下拉选择器
            function initDateTimeDropdowns() {
                // 年下拉框 (1990-2200)
                const yearDropdown = document.getElementById('year-dropdown');
                yearDropdown.innerHTML = ''; // 清空现有内容
                for (let year = 1990; year <= 2200; year++) {
                    const div = document.createElement('div');
                    div.textContent = year;
                    div.addEventListener('click', () => {
                        document.getElementById('year-dropdown-btn').textContent = year;
                        updateDayDropdown(); // 更新日下拉框，因为不同年份可能有不同的天数
                    });
                    yearDropdown.appendChild(div);
                }

                // 月下拉框 (1-12)
                const monthDropdown = document.getElementById('month-dropdown');
                monthDropdown.innerHTML = '';
                for (let month = 1; month <= 12; month++) {
                    const div = document.createElement('div');
                    div.textContent = month.toString().padStart(2, '0'); // 显示为两位数
                    div.addEventListener('click', () => {
                        document.getElementById('month-dropdown-btn').textContent = month.toString().padStart(2, '0');
                        updateDayDropdown(); // 更新日下拉框，因为不同月份可能有不同的天数
                    });
                    monthDropdown.appendChild(div);
                }

                // 日下拉框 - 根据年月动态生成，显示为两位数
                updateDayDropdown();

                // 时下拉框 (0-23)
                const hourDropdown = document.getElementById('hour-dropdown');
                hourDropdown.innerHTML = '';
                for (let hour = 0; hour < 24; hour++) {
                    const div = document.createElement('div');
                    div.textContent = hour.toString().padStart(2, '0');
                    div.addEventListener('click', () => {
                        document.getElementById('hour-dropdown-btn').textContent = hour.toString().padStart(2, '0');
                    });
                    hourDropdown.appendChild(div);
                }

                // 分下拉框 (0-59)
                const minuteDropdown = document.getElementById('minute-dropdown');
                minuteDropdown.innerHTML = ''; // 清空现有内容
                for (let minute = 0; minute < 60; minute++) {
                    const div = document.createElement('div');
                    div.textContent = minute.toString().padStart(2, '0');
                    div.addEventListener('click', () => {
                        document.getElementById('minute-dropdown-btn').textContent = minute.toString().padStart(2, '0');
                    });
                    minuteDropdown.appendChild(div);
                }

                // 秒下拉框 (0-59)
                const secondDropdown = document.getElementById('second-dropdown');
                secondDropdown.innerHTML = ''; // 清空现有内容
                for (let second = 0; second < 60; second++) {
                    const div = document.createElement('div');
                    div.textContent = second.toString().padStart(2, '0');
                    div.addEventListener('click', () => {
                        document.getElementById('second-dropdown-btn').textContent = second.toString().padStart(2, '0');
                    });
                    secondDropdown.appendChild(div);
                }

                // 初始化日下拉框
                // updateDayDropdown();
            }

            // 更新日下拉框（根据年月）
            function updateDayDropdown() {
                const year = parseInt(document.getElementById('year-dropdown-btn').textContent);
                const month = parseInt(document.getElementById('month-dropdown-btn').textContent);
                const daysInMonth = new Date(year, month, 0).getDate();
                
                const dayDropdown = document.getElementById('day-dropdown');
                dayDropdown.innerHTML = '';
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const div = document.createElement('div');
                    div.textContent = day.toString().padStart(2, '0');
                    div.addEventListener('click', () => {
                        document.getElementById('day-dropdown-btn').textContent = day.toString().padStart(2, '0');
                    });
                    dayDropdown.appendChild(div);
                }
                
                // 确保当前选择的日期不超过最大天数
                const currentDay = parseInt(document.getElementById('day-dropdown-btn').textContent);
                if (currentDay > daysInMonth) {
                    document.getElementById('day-dropdown-btn').textContent = daysInMonth.toString().padStart(2, '0');
                }
            }

            // 修改formatDateForInput函数以支持时间
            function formatDateForInput() {
                const year = document.getElementById('year-dropdown-btn').textContent;
                const month = document.getElementById('month-dropdown-btn').textContent;
                const day = document.getElementById('day-dropdown-btn').textContent;
                const hours = document.getElementById('hour-dropdown-btn').textContent;
                const minutes = document.getElementById('minute-dropdown-btn').textContent;
                const seconds = document.getElementById('second-dropdown-btn').textContent;
                return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
            }

            // 显示日期选择模态框的函数以支持时间
            function showDateModal(defaultDateTime = null) {
                return new Promise((resolve) => {
                    dateModalResolve = resolve;
                    
                    // 初始化下拉选择器
                    initDateTimeDropdowns();
                    
                    // 设置默认值
                    if (defaultDateTime) {
                        const date = new Date(defaultDateTime);
                        document.getElementById('year-dropdown-btn').textContent = date.getFullYear();
                        document.getElementById('month-dropdown-btn').textContent = (date.getMonth() + 1).toString().padStart(2, '0');
                        document.getElementById('day-dropdown-btn').textContent = date.getDate().toString().padStart(2, '0');
                        document.getElementById('hour-dropdown-btn').textContent = date.getHours().toString().padStart(2, '0');
                        document.getElementById('minute-dropdown-btn').textContent = date.getMinutes().toString().padStart(2, '0');
                        document.getElementById('second-dropdown-btn').textContent = date.getSeconds().toString().padStart(2, '0');
                    } else {
                        const now = new Date();
                        document.getElementById('year-dropdown-btn').textContent = now.getFullYear();
                        document.getElementById('month-dropdown-btn').textContent = (now.getMonth() + 1).toString().padStart(2, '0');
                        document.getElementById('day-dropdown-btn').textContent = now.getDate().toString().padStart(2, '0');
                        document.getElementById('hour-dropdown-btn').textContent = now.getHours().toString().padStart(2, '0');
                        document.getElementById('minute-dropdown-btn').textContent = now.getMinutes().toString().padStart(2, '0');
                        document.getElementById('second-dropdown-btn').textContent = now.getSeconds().toString().padStart(2, '0');
                    }
                    
                    // 更新日下拉框
                    updateDayDropdown();
                    
                    dateModal.style.display = 'flex';
                });
            }

            // 确认日期选择按钮点击事件
            document.getElementById('date-modal-confirm').addEventListener('click', () => {
                if (dateModalResolve) {
                    dateModalResolve(formatDateForInput());
                    dateModalResolve = null;
                }
                dateModal.style.display = 'none';
            });

            // 取消日期选择按钮点击事件
            document.getElementById('date-modal-cancel').addEventListener('click', () => {
                if (dateModalResolve) {
                    dateModalResolve(null);
                    dateModalResolve = null;
                }
                dateModal.style.display = 'none';
            });

            // 关闭日期模态框按钮点击事件
            document.getElementById('close-date-modal').addEventListener('click', () => {
                if (dateModalResolve) {
                    dateModalResolve(null);
                    dateModalResolve = null;
                }
                dateModal.style.display = 'none';
            });

            // ==================== 按钮功能替换 ====================
            // 修改设置到期时间的功能，使用日期选择模态框
            document.getElementById('set-due-date-btn').addEventListener('click', async () => {
                const dateStr = await showDateModal(currentCard.dueDate);
                if (dateStr) {
                    currentCard.dueDate = dateStr;
                    saveData();
                    renderDueDate();
                }
            });

            // 修改添加子任务的功能，使用自定义输入模态框
            document.getElementById('add-subtask-btn').addEventListener('click', async () => {
                const title = await showInputModal('输入子任务标题', '');
                if (title) {
                    if (!currentCard.subtasks) currentCard.subtasks = [];
                    currentCard.subtasks.push({
                        title,
                        completed: false
                    });
                    saveData();
                    renderSubtasks();
                }
            });

            // ==================== 看板渲染功能 ====================
            // 渲染看板
            function renderKanban() {
                const container = document.getElementById('kanban-container');
                container.innerHTML = '';

                kanbanData.forEach((column, columnIndex) => {
                    const columnElement = document.createElement('div');
                    columnElement.className = 'column';
                    columnElement.dataset.columnIndex = columnIndex;

                    const columnHeader = document.createElement('div');
                    columnHeader.className = 'column-header';

                    const title = document.createElement('div');
                    title.className = 'column-title';
                    title.textContent = column.title;
                    title.contentEditable = true;
                    title.addEventListener('blur', () => {
                        column.title = title.textContent;
                        saveData();
                    });

                    const deleteBtn = document.createElement('button');
                    // deleteBtn.className = 'delete-column';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '<i class="ri-delete-bin-line"></i>';
                    deleteBtn.addEventListener('click', () => {
                        showConfirmation('确定要删除这一列吗？', () => {
                            kanbanData.splice(columnIndex, 1);
                            saveData();
                            renderKanban();
                        });
                    });

                    columnHeader.appendChild(title);
                    columnHeader.appendChild(deleteBtn);
                    columnElement.appendChild(columnHeader);

                    column.cards.forEach((card, cardIndex) => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card';
                        if (card.completed) {
                            cardElement.classList.add('completed');
                        }
                        cardElement.draggable = true;
                        cardElement.dataset.cardIndex = cardIndex;

                        // 添加完成状态复选框
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.className = 'card-checkbox-label';
                        if (card.completed) {
                            checkboxLabel.classList.add('checked');
                        }
                        checkboxLabel.addEventListener('click', (e) => {
                            e.stopPropagation(); // 防止事件冒泡影响卡片点击
                            card.completed = !card.completed;
                            if (card.completed) {
                                checkboxLabel.classList.add('checked');
                            } else {
                                checkboxLabel.classList.remove('checked');
                            }
                            saveData();
                            renderKanban();
                        });
                        cardElement.appendChild(checkboxLabel);

                        const cardHeader = document.createElement('div');
                        cardHeader.className = 'card-header';

                        const cardTitle = document.createElement('div');
                        cardTitle.className = 'card-title';
                        cardTitle.textContent = card.title;

                        const cardActions = document.createElement('div');
                        cardActions.className = 'card-actions';

                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '<i class="ri-edit-line"></i>';
                        editBtn.title = '编辑';
                        editBtn.addEventListener('click', () => {
                            openCardDetail(columnIndex, cardIndex);
                        });

                        const deleteCardBtn = document.createElement('button');
                        deleteCardBtn.innerHTML = '<i class="ri-delete-bin-line"></i>';
                        deleteCardBtn.title = '删除';
                        deleteCardBtn.className = 'delete-btn';
                        deleteCardBtn.addEventListener('click', () => {
                            const currentCardIndex = cardIndex;
                            const currentColumnIndex = columnIndex;
                            showConfirmation('确定要删除这张卡片吗？', () => {
                                kanbanData[currentColumnIndex].cards.splice(currentCardIndex, 1);
                                saveData();
                                renderKanban();
                            });
                        });

                        cardActions.appendChild(editBtn);
                        cardActions.appendChild(deleteCardBtn);

                        cardHeader.appendChild(cardTitle);
                        cardHeader.appendChild(cardActions);

                        const cardContent = document.createElement('div');
                        cardContent.className = 'card-content';
                        cardContent.innerHTML = convertMarkdownToHtml(card.content);

                        // 显示标签
                        if (card.tags && card.tags.length > 0) {
                            const tagsContainer = document.createElement('div');
                            tagsContainer.className = 'tags-container';

                            card.tags.forEach(tag => {
                                const tagElement = document.createElement('span');
                                tagElement.className = `tag tag-${tag.color}`;
                                tagElement.textContent = tag.text;
                                tagsContainer.appendChild(tagElement);
                            });

                            cardElement.appendChild(tagsContainer);
                        }

                        // 显示到期时间
                        if (card.dueDate) {
                            const dueDateElement = document.createElement('div');
                            dueDateElement.className = 'due-date';
                            
                            const now = new Date();
                            const dueDate = new Date(card.dueDate);
                            
                            // 计算提醒
                            const reminder = calculateReminder(card.dueDate);
                            
                            if (reminder) {
                                const reminderElement = document.createElement('div');
                                reminderElement.className = `reminder ${reminder.class}`;
                                reminderElement.textContent = reminder.text;
                                dueDateElement.appendChild(reminderElement);
                                
                                // 添加过期样式
                                if (reminder.isOverdue) {
                                    cardElement.classList.add('card-overdue');
                                    // 确保标题也应用过期样式
                                    const titleElement = cardElement.querySelector('.card-title');
                                    if (titleElement) {
                                        titleElement.classList.add('overdue-text');
                                    }
                                }
                            }
                            cardElement.appendChild(dueDateElement);
                        }

                        cardElement.appendChild(cardHeader);
                        cardElement.appendChild(cardContent);

                        // 显示子任务状态（如果有子任务）
                        if (card.subtasks && card.subtasks.length > 0) {
                            const completedCount = card.subtasks.filter(st => st.completed).length;
                            const subtaskStatus = document.createElement('div');
                            subtaskStatus.className = 'subtask-status';
                            subtaskStatus.innerHTML = `<i class="ri-task-line"></i> ${completedCount}/${card.subtasks.length} 完成`;
                            cardElement.appendChild(subtaskStatus);
                        }

                        // 拖放功能 - 优化版本
                        let animationFrameId = null;
                        cardElement.addEventListener('dragstart', (e) => {
                            e.dataTransfer.setData('text/plain', `${columnIndex}-${cardIndex}`);
                            setTimeout(() => {
                                cardElement.classList.add('dragging');
                                // 创建拖拽镜像
                                const mirror = cardElement.cloneNode(true);
                                mirror.style.position = 'fixed';
                                mirror.style.width = `${cardElement.offsetWidth}px`;
                                mirror.style.opacity = '0.8';
                                mirror.style.zIndex = '1000';
                                mirror.style.pointerEvents = 'none';
                                mirror.style.transform = 'rotate(5deg)';
                                mirror.id = 'drag-mirror';
                                document.body.appendChild(mirror);

                                // 更新镜像位置
                                const updateMirrorPosition = (event) => {
                                    if (animationFrameId) {
                                        cancelAnimationFrame(animationFrameId);
                                    }
                                    animationFrameId = requestAnimationFrame(() => {
                                        mirror.style.left = `${event.clientX - mirror.offsetWidth / 2}px`;
                                        mirror.style.top = `${event.clientY - 10}px`;
                                    });
                                };

                                document.addEventListener('dragover', updateMirrorPosition);

                                // 清理函数
                                const cleanup = () => {
                                    document.removeEventListener('dragover', updateMirrorPosition);
                                    if (document.getElementById('drag-mirror')) {
                                        document.body.removeChild(mirror);
                                    }
                                };
                            }, 0);
                        });

                        cardElement.addEventListener('dragend', () => {
                            cardElement.classList.remove('dragging');
                            // 移除所有放置指示器
                            removeAllDropIndicators();
                            
                            // 移除拖拽镜像（如果存在）
                            const mirror = document.getElementById('drag-mirror');
                            if (mirror) {
                                document.body.removeChild(mirror);
                            }
                            
                            // 移除所有列的dropzone类
                            document.querySelectorAll('.column').forEach(column => {
                                column.classList.remove('dropzone');
                            });
                            
                            // 添加清理函数中的逻辑
                            document.removeEventListener('dragover', updateMirrorPosition);
                            if (document.getElementById('drag-mirror')) {
                                document.body.removeChild(document.getElementById('drag-mirror'));
                            }
                            if (animationFrameId) {
                                cancelAnimationFrame(animationFrameId);
                                animationFrameId = null;
                            }
                        });

                        columnElement.appendChild(cardElement);
                    });

                    // 添加卡片表单
                    const addCardForm = document.createElement('div');
                    addCardForm.className = 'add-card-form';
                    addCardForm.id = `add-card-form-${columnIndex}`;

                    const cardTitleInput = document.createElement('input');
                    cardTitleInput.type = 'text';
                    cardTitleInput.placeholder = '输入卡片标题...';
                    cardTitleInput.className = 'card-title-input';

                    const cardContentTextarea = document.createElement('textarea');
                    cardContentTextarea.placeholder = '输入卡片内容（可选）...';

                    const formActions = document.createElement('div');
                    formActions.className = 'add-card-form-actions';

                    const addBtn = document.createElement('button');
                    addBtn.className = 'add-btn';
                    addBtn.textContent = '添加';
                    addBtn.addEventListener('click', () => {
                        const title = cardTitleInput.value.trim();
                        const content = cardContentTextarea.value.trim();
                        if (title) {
                            column.cards.push({
                                title,
                                content: content || ' ',
                                completed: false,
                                tags: [],
                                dueDate: null,
                                subtasks: []
                            });
                            saveData();
                            renderKanban();

                            // 重置表单
                            cardTitleInput.value = '';
                            cardContentTextarea.value = '';
                            addCardForm.style.display = 'none';
                            addCardBtn.style.display = 'block';
                        }
                    });

                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'cancel-btn';
                    cancelBtn.textContent = '取消';
                    cancelBtn.addEventListener('click', () => {
                        addCardForm.style.display = 'none';
                        addCardBtn.style.display = 'block';
                    });

                    formActions.appendChild(addBtn);
                    formActions.appendChild(cancelBtn);

                    addCardForm.appendChild(cardTitleInput);
                    addCardForm.appendChild(cardContentTextarea);
                    addCardForm.appendChild(formActions);

                    // 添加卡片按钮
                    const addCardBtn = document.createElement('button');
                    addCardBtn.className = 'add-card-btn';
                    addCardBtn.innerHTML = '<i class="ri-add-line"></i> 添加卡片';
                    addCardBtn.addEventListener('click', () => {
                        addCardBtn.style.display = 'none';
                        addCardForm.style.display = 'block';
                        cardTitleInput.focus();
                    });

                    columnElement.appendChild(addCardBtn);
                    columnElement.appendChild(addCardForm);

                    // 放置区域 - 优化版本
                    columnElement.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        columnElement.classList.add('dropzone');

                        // 获取列中的所有卡片（不包含正在拖动的卡片）
                        const cards = columnElement.querySelectorAll('.card:not(.dragging)');

                        // 如果没有卡片，直接放在列的开头
                        if (cards.length === 0) {
                            // 移除所有现有的放置指示器
                            removeAllDropIndicators();

                            // 创建放置指示器放在列开头
                            const indicator = createDropIndicator();
                            const columnHeader = columnElement.querySelector('.column-header');
                            if (columnHeader && columnHeader.nextSibling) {
                                columnHeader.parentNode.insertBefore(indicator, columnHeader.nextSibling);
                            } else {
                                columnElement.appendChild(indicator);
                            }
                            return;
                        }

                        // 查找最近的卡片和位置
                        let closestCard = null;
                        let closestDistance = Infinity;
                        let insertPosition = 'after'; // 'before' 或 'after'

                        // 检查是否应该放在第一个卡片之前
                        if (cards.length > 0) {
                            const firstCard = cards[0];
                            const firstCardRect = firstCard.getBoundingClientRect();
                            const distanceToFirst = Math.abs(e.clientY - firstCardRect.top);

                            if (distanceToFirst < closestDistance && e.clientY < firstCardRect.top + firstCardRect.height / 3) {
                                closestDistance = distanceToFirst;
                                closestCard = firstCard;
                                insertPosition = 'before';
                            }
                        }

                        // 检查是否应该放在最后一个卡片之后
                        const lastCard = cards[cards.length - 1];
                        const lastCardRect = lastCard.getBoundingClientRect();
                        const distanceToLast = Math.abs(e.clientY - lastCardRect.bottom);

                        if (distanceToLast < closestDistance && e.clientY > lastCardRect.bottom - lastCardRect.height / 3) {
                            closestDistance = distanceToLast;
                            closestCard = lastCard;
                            insertPosition = 'after';
                        }

                        // 检查中间位置
                        for (let i = 0; i < cards.length - 1; i++) {
                            const currentCard = cards[i];
                            const nextCard = cards[i + 1];

                            const currentRect = currentCard.getBoundingClientRect();
                            const nextRect = nextCard.getBoundingClientRect();

                            // 计算两个卡片中间的Y坐标
                            const middleY = (currentRect.bottom + nextRect.top) / 2;
                            const distanceToMiddle = Math.abs(e.clientY - middleY);

                            if (distanceToMiddle < closestDistance) {
                                closestDistance = distanceToMiddle;
                                closestCard = currentCard;
                                insertPosition = 'after';
                            }
                        }

                        // 移除所有现有的放置指示器
                        removeAllDropIndicators();

                        // 创建放置指示器
                        const indicator = createDropIndicator();

                        if (closestCard) {
                            if (insertPosition === 'before') {
                                closestCard.before(indicator);
                            } else {
                                closestCard.after(indicator);
                            }
                        } else {
                            // 放在列末尾
                            const addCardBtn = columnElement.querySelector('.add-card-btn');
                            if (addCardBtn) {
                                addCardBtn.before(indicator);
                            } else {
                                columnElement.appendChild(indicator);
                            }
                        }
                    });

                    columnElement.addEventListener('dragleave', (e) => {
                        // 只有当鼠标真正离开列区域时才移除dropzone类和放置指示器
                        if (!columnElement.contains(e.relatedTarget)) {
                            columnElement.classList.remove('dropzone');
                            // 移除所有放置指示器
                            document.querySelectorAll('.drop-indicator').forEach(indicator => {
                                indicator.remove();
                            });
                        }
                    });

                    columnElement.addEventListener('drop', (e) => {
                        e.preventDefault();
                        columnElement.classList.remove('dropzone');

                        // 移除所有放置指示器
                        removeAllDropIndicators();

                        const data = e.dataTransfer.getData('text/plain').split('-');
                        const fromColumn = parseInt(data[0]);
                        const fromCard = parseInt(data[1]);

                        // 获取放置指示器前面的卡片索引
                        const indicators = columnElement.querySelectorAll('.drop-indicator');
                        let targetIndex = 0;

                        if (indicators.length > 0) {
                            const indicator = indicators[0];
                            const allElements = Array.from(columnElement.children);
                            const indicatorIndex = allElements.indexOf(indicator);

                            // 计算目标索引（排除非卡片元素）
                            let cardCount = 0;
                            for (let i = 0; i < indicatorIndex; i++) {
                                if (allElements[i].classList.contains('card')) {
                                    cardCount++;
                                }
                            }
                            targetIndex = cardCount;
                        } else {
                            // 如果没有指示器，放在最后
                            targetIndex = kanbanData[columnIndex].cards.length;
                        }

                        // 移动卡片
                        const card = kanbanData[fromColumn].cards[fromCard];

                        if (fromColumn === columnIndex) {
                            // 同列移动
                            let adjustedTargetIndex = targetIndex;
                            if (fromCard < targetIndex) {
                                adjustedTargetIndex--; // 调整目标索引，因为原卡片将被移除
                            }
                            kanbanData[fromColumn].cards.splice(fromCard, 1);
                            kanbanData[columnIndex].cards.splice(adjustedTargetIndex, 0, card);
                        } else {
                            // 跨列移动
                            kanbanData[fromColumn].cards.splice(fromCard, 1);
                            kanbanData[columnIndex].cards.splice(targetIndex, 0, card);
                        }

                        saveData();
                        renderKanban();
                    });

                    container.appendChild(columnElement);
                });

                // 添加列按钮
                const addColumn = document.createElement('div');
                addColumn.className = 'add-column';

                const addColumnBtn = document.createElement('button');
                addColumnBtn.id = 'add-column-btn';
                addColumnBtn.innerHTML = '<i class="ri-add-line"></i> 添加列';
                addColumnBtn.addEventListener('click', async () => {
                    const title = await showInputModal('请输入列标题', '');
                    if (title) {
                        kanbanData.push({
                            title: title,
                            cards: []
                        });
                        saveData();
                        renderKanban();
                    }
                });

                addColumn.appendChild(addColumnBtn);
                container.appendChild(addColumn);

            }

            // ==================== 工具函数 ====================
            // 简单的Markdown转HTML函数
            function convertMarkdownToHtml(text) {
                if (!text || text.trim() === '') return '<p></p>';
                return text
                    .replace(/^# (.*)/gm, '<h3>$1</h3>')
                    .replace(/^## (.*)/gm, '<h4>$1</h4>')
                    .replace(/^### (.*)/gm, '<h5>$1</h5>')
                    .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/g, '<em>$1</em>')
                    .replace(/`(.*)`/g, '<code>$1</code>')
                    .replace(/\n/g, '<br>');
            }

            // 格式化日期
            function formatDate(date) {
                return new Date(date).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            // 修改calculateReminder函数以支持精确到秒的提醒
            function calculateReminder(dueDateTime) {
                if (!dueDateTime) return null;
                
                const now = new Date();
                const due = new Date(dueDateTime);
                const diffMs = due - now;
                
                // 已过期
                if (diffMs < 0) {
                    return {
                        text: `已过期: ${formatDateTime(due)}`,
                        class: 'reminder-red overdue-text',
                        isOverdue: true
                    };
                }
                
                // 计算时间差（天、小时、分钟、秒）
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
                
                // 按时间间隔分类
                if (diffDays >= 2) {
                    return {
                        text: `剩余: ${diffDays}天`,
                        class: 'reminder-blue',
                        isOverdue: false
                    };
                } else if (diffDays === 1) {
                    return {
                        text: '剩余: 1天',
                        class: 'reminder-blue',
                        isOverdue: false
                    };
                } else if (diffHours >= 5) {
                    return {
                        text: `剩余: ${diffHours}小时${diffMinutes}分`,
                        class: 'reminder-orange',
                        isOverdue: false
                    };
                } else if (diffHours >= 2) {
                    return {
                        text: `剩余: ${diffHours}小时${diffMinutes}分`,
                        class: 'reminder-orange',
                        isOverdue: false
                    };
                } else if (diffHours >= 1) {
                    return {
                        text: `剩余: ${diffHours}小时${diffMinutes}分`,
                        class: 'reminder-orange',
                        isOverdue: false
                    };
                } else if (diffMinutes >= 30) {
                    return {
                        text: `剩余: ${diffMinutes}分${diffSeconds}秒`,
                        class: 'reminder-red',
                        isOverdue: false
                    };
                } else if (diffMinutes >= 15) {
                    return {
                        text: `剩余: ${diffMinutes}分${diffSeconds}秒`,
                        class: 'reminder-red',
                        isOverdue: false
                    };
                } else if (diffMinutes >= 10) {
                    return {
                        text: `剩余: ${diffMinutes}分${diffSeconds}秒`,
                        class: 'reminder-red',
                        isOverdue: false
                    };
                } else if (diffMinutes >= 5) {
                    return {
                        text: `剩余: ${diffMinutes}分${diffSeconds}秒`,
                        class: 'reminder-red',
                        isOverdue: false
                    };
                } else {
                    return {
                        text: `剩余: ${diffMinutes}分${diffSeconds}秒`,
                        class: 'reminder-red overdue-text',
                        isOverdue: false
                    };
                }
            }

            // 添加格式化日期时间的函数
            function formatDateTime(date) {
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            // ==================== 卡片详情功能 ====================
            // 打开卡片详情
            function openCardDetail(columnIndex, cardIndex) {
                currentColumnIndex = columnIndex;
                currentCardIndex = cardIndex;
                currentCard = kanbanData[columnIndex].cards[cardIndex];

                // 更新详情视图
                document.getElementById('card-detail-title').textContent = currentCard.title;
                document.getElementById('card-detail-content').innerHTML = convertMarkdownToHtml(currentCard.content);

                // 更新标签
                renderTags();

                // 更新到期时间
                renderDueDate();

                // 更新子任务
                renderSubtasks();

                // 显示详情视图，隐藏编辑视图
                document.getElementById('card-detail-view').style.display = 'block';
                document.getElementById('edit-mode').style.display = 'none';

                // 更新模态框标题
                document.getElementById('modal-title').innerHTML = '<i class="ri-information-line"></i> 卡片详情';

                // 显示模态框
                document.getElementById('card-modal').style.display = 'flex';

                // 标题编辑事件
                const titleElement = document.getElementById('card-detail-title');
                titleElement.addEventListener('blur', () => {
                    currentCard.title = titleElement.textContent;
                    saveData();
                    renderKanban(); // 更新看板显示
                });

                // 更新复选框状态
                const checkboxLabel = document.getElementById('card-detail-checkbox-label');
                checkboxLabel.className = 'card-checkbox-label';
                if (currentCard.completed) {
                    checkboxLabel.classList.add('checked');
                } else {
                    checkboxLabel.classList.remove('checked');
                }

                // 添加点击事件
                checkboxLabel.onclick = function(e) {
                    e.stopPropagation();
                    currentCard.completed = !currentCard.completed;
                    if (currentCard.completed) {
                        checkboxLabel.classList.add('checked');
                    } else {
                        checkboxLabel.classList.remove('checked');
                    }
                    saveData();
                    renderKanban(); // 更新看板显示
                };
            }

            // 渲染标签
            function renderTags() {
                const tagsContainer = document.getElementById('tags-container');
                tagsContainer.innerHTML = '';

                if (currentCard.tags && currentCard.tags.length > 0) {
                    currentCard.tags.forEach((tag, index) => {
                        const tagElement = document.createElement('span');
                        tagElement.className = `tag tag-${tag.color}`;
                        tagElement.textContent = tag.text;

                        // 添加删除功能
                        tagElement.addEventListener('click', () => {
                            currentCard.tags.splice(index, 1);
                            saveData();
                            renderTags();
                        });

                        tagsContainer.appendChild(tagElement);
                    });
                }
            }

            // 修改renderDueDate函数以显示完整日期时间
            function renderDueDate() {
                const dueDateContainer = document.getElementById('due-date-container');
                dueDateContainer.innerHTML = '';

                if (currentCard.dueDate) {
                    const now = new Date();
                    const dueDate = new Date(currentCard.dueDate);

                    if (dueDate < now) {
                        dueDateContainer.classList.add('overdue');
                        dueDateContainer.innerHTML = `<i class="ri-error-warning-line"></i> 已过期: ${formatDateTime(dueDate)}`;
                    } else {
                        dueDateContainer.innerHTML = `<i class="ri-time-line"></i> 到期: ${formatDateTime(dueDate)}`;
                    }
                }
            }

            // 渲染子任务
            function renderSubtasks() {
                const subtasksList = document.getElementById('subtasks-list');
                subtasksList.innerHTML = '';

                if (currentCard.subtasks && currentCard.subtasks.length > 0) {
                    let completedCount = 0;

                    currentCard.subtasks.forEach((subtask, index) => {
                        if (subtask.completed) completedCount++;

                        const subtaskElement = document.createElement('div');
                        subtaskElement.className = 'subtask';

                        // 创建子任务checkbox
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.className = 'subtask-checkbox';
                        checkbox.checked = subtask.completed;
                        checkbox.id = `subtask-${Date.now()}-${index}`;
                        checkbox.style.display = 'none';

                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.htmlFor = checkbox.id;
                        checkboxLabel.className = 'subtask-checkbox-label';
                        if (subtask.completed) {
                            checkboxLabel.classList.add('checked');
                        }
                        checkboxLabel.addEventListener('click', () => {
                            subtask.completed = !subtask.completed;
                            checkbox.checked = subtask.completed;
                            if (subtask.completed) {
                                checkboxLabel.classList.add('checked');
                            } else {
                                checkboxLabel.classList.remove('checked');
                            }
                            saveData();
                            renderSubtasks();
                        });

                        const content = document.createElement('div');
                        content.className = 'subtask-content';
                        content.textContent = subtask.title;

                        const actions = document.createElement('div');
                        actions.className = 'subtask-actions';

                        // 在renderSubtasks函数中，更新子任务删除按钮
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="ri-delete-bin-line"></i>';
                        deleteBtn.className = 'delete-btn'; // 添加统一样式类
                        deleteBtn.title = '删除子任务';
                        deleteBtn.addEventListener('click', () => {
                            currentCard.subtasks.splice(index, 1);
                            saveData();
                            renderSubtasks();
                        });

                        actions.appendChild(deleteBtn);

                        subtaskElement.appendChild(checkbox);
                        subtaskElement.appendChild(checkboxLabel);
                        subtaskElement.appendChild(content);
                        subtaskElement.appendChild(actions);

                        subtasksList.appendChild(subtaskElement);
                    });

                    // 更新进度 - 添加对零除的处理
                    const progress = currentCard.subtasks.length > 0 
                        ? (completedCount / currentCard.subtasks.length) * 100 
                        : 0;
                    document.getElementById('subtask-progress').style.width = `${progress}%`;

                    document.getElementById('subtask-progress-text').textContent = 
                        `${completedCount}/${currentCard.subtasks.length} 已完成`;
                } else {
                    document.getElementById('subtask-progress').style.width = '0%';
                    document.getElementById('subtask-progress-text').textContent = '暂无子任务';
                }
            }

            // ==================== 确认对话框功能 ====================
            // 显示确认对话框
            function showConfirmation(message, confirmCallback) {
                document.getElementById('confirmation-message').textContent = message;
                document.getElementById('confirmation-modal').style.display = 'flex';

                document.getElementById('confirmation-confirm').onclick = function() {
                    confirmCallback();
                    document.getElementById('confirmation-modal').style.display = 'none';
                };

                document.getElementById('confirmation-cancel').onclick = function() {
                    document.getElementById('confirmation-modal').style.display = 'none';
                };
            }

            // ==================== 黑暗模式功能 ====================
            // 黑暗模式切换按钮
            const themeSwitchBtn = document.getElementById('theme-switch');
            // 初始化图标
            if (document.body.classList.contains('dark-mode')) {
                // 替换为 Remix Icon
                themeSwitchBtn.innerHTML = '<i class="ri-sun-line"></i>';
            } else {
                // 替换为 Remix Icon
                themeSwitchBtn.innerHTML = '<i class="ri-moon-line"></i>';
            }

            // 切换主题时的图标更新
            themeSwitchBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('theme', theme);

                if (theme === 'dark') {
                    themeSwitchBtn.innerHTML = '<i class="ri-sun-line"></i>';
                } else {
                    themeSwitchBtn.innerHTML = '<i class="ri-moon-line"></i>';
                }
            });

            // ==================== 模态框功能 ====================
            const modal = document.getElementById('card-modal');
            const closeBtn = document.querySelector('.close');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const saveEditBtn = document.getElementById('save-edit');
            const editCardBtn = document.getElementById('edit-card-btn');

            function closeModal() {
                modal.style.display = 'none';
            }

            // 进入编辑模式
            editCardBtn.addEventListener('click', () => {
                document.getElementById('card-detail-view').style.display = 'none';
                document.getElementById('edit-mode').style.display = 'block';

                document.getElementById('modal-title').innerHTML = '<i class="ri-edit-line"></i> 编辑卡片';
                document.getElementById('card-content-text').value = currentCard.content;
                updateMarkdownPreview();
            });

            // 保存编辑
            saveEditBtn.addEventListener('click', () => {
                const content = document.getElementById('card-content-text').value.trim();
                if (content) {
                    currentCard.content = content;
                    saveData();
                    renderKanban();
                    closeModal();
                }
            });

            // 取消编辑
            cancelEditBtn.addEventListener('click', () => {
                document.getElementById('edit-mode').style.display = 'none';
                document.getElementById('card-detail-view').style.display = 'block';
                document.getElementById('modal-title').innerHTML = '<i class="fas fa-info-circle"></i> 卡片详情';
            });

            closeBtn.addEventListener('click', closeModal);

            // 点击模态框外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // ==================== Markdown编辑功能 ====================
            // 更新Markdown预览
            function updateMarkdownPreview() {
                const text = document.getElementById('card-content-text').value;
                document.getElementById('markdown-preview').innerHTML = convertMarkdownToHtml(text);
            }

            document.getElementById('card-content-text').addEventListener('input', updateMarkdownPreview);

            // 格式工具栏功能
            document.querySelectorAll('.format-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const prefix = button.dataset.prefix;
                    const suffix = button.dataset.suffix;

                    const textarea = document.getElementById('card-content-text');
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const selectedText = textarea.value.substring(start, end);

                    // 插入格式化的文本
                    textarea.value = textarea.value.substring(0, start) + 
                                    prefix + selectedText + suffix + 
                                    textarea.value.substring(end);

                    // 设置光标位置
                    const newCursorPos = start + prefix.length + selectedText.length + suffix.length;
                    textarea.setSelectionRange(newCursorPos, newCursorPos);

                    textarea.focus();
                    updateMarkdownPreview();
                });
            });

            // ==================== 文件操作功能 ====================
            // 保存到Markdown文件
            document.getElementById('save-file').addEventListener('click', () => {
                let markdownContent = '';

                kanbanData.forEach(column => {
                    markdownContent += `# ${column.title}\n\n`;

                    column.cards.forEach(card => {
                        // 添加完成状态标记
                        const completionMark = card.completed ? '[x]' : '[ ]';
                        markdownContent += `## ${completionMark} ${card.title}\n\n`;
                        markdownContent += card.content + '\n\n';

                        // 添加标签信息
                        if (card.tags && card.tags.length > 0) {
                            markdownContent += `标签: ${card.tags.map(t => t.text).join(', ')}\n\n`;
                        }

                        // 添加到期时间
                        if (card.dueDate) {
                            markdownContent += `到期时间: ${card.dueDate}\n\n`;
                        }

                        // 添加子任务
                        if (card.subtasks && card.subtasks.length > 0) {
                            markdownContent += '### 子任务\n\n';
                            card.subtasks.forEach(subtask => {
                                const subtaskCompletionMark = subtask.completed ? '[x]' : '[ ]';
                                markdownContent += `- ${subtaskCompletionMark} ${subtask.title}\n`;
                            });
                            markdownContent += '\n';
                        }

                        markdownContent += '---\n\n';
                    });
                });

                // 添加自定义内容区域
                markdownContent += '<!-- CUSTOM_DATA_START -->\n';
                markdownContent += JSON.stringify({
                    // 这里可以添加任何自定义数据
                    version: '1.0',
                    exportDate: new Date().toISOString()
                });
                markdownContent += '\n<!-- CUSTOM_DATA_END -->\n';

                const blob = new Blob([markdownContent], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = 'markdown-kanban.md';
                a.click();

                URL.revokeObjectURL(url);
            });

            // 从Markdown文件加载
            document.getElementById('load-file').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        showConfirmation('加载文件将覆盖当前看板，确定要继续吗？', () => {
                            parseMarkdownFile(content);
                            // 再次弹框告知“加载成功”
                            showConfirmation('数据加载成功！', () => {});
                        });
                    } catch (error) {
                        showConfirmation('导入失败：文件格式错误', () => {});
                    }
                };
                reader.readAsText(file);

                e.target.value = '';
            });

            // 新增解析函数
            function parseMarkdownFile(content) {
                const newData = [];
                let currentColumn = null;
                let currentCard = null;

                // 提取自定义数据
                const customDataMatch = content.match(/<!-- CUSTOM_DATA_START -->\s*([\s\S]*?)\s*<!-- CUSTOM_DATA_END -->/);
                if (customDataMatch) {
                    try {
                        const customData = JSON.parse(customDataMatch[1]);
                        console.log('加载自定义数据:', customData);
                    } catch (e) {
                        console.error('解析自定义数据失败:', e);
                    }

                    // 移除自定义数据部分，继续解析主要内容
                    content = content.replace(/<!-- CUSTOM_DATA_START -->\s*[\s\S]*?\s*<!-- CUSTOM_DATA_END -->/, '');
                }

                const lines = content.split('\n');
                let inCustomSection = false;

                lines.forEach(line => {
                    if (line.startsWith('# ')) {
                        // 新列
                        currentColumn = {
                            title: line.substring(2).trim(),
                            cards: []
                        };
                        newData.push(currentColumn);
                    } else if (line.startsWith('## ')) {
                        // 新卡片 - 解析完成状态
                        const cardTitleLine = line.substring(3).trim();
                        let completed = false;
                        let title = cardTitleLine;

                        // 检查是否有完成状态标记
                        if (cardTitleLine.startsWith('[x] ') || cardTitleLine.startsWith('[ ] ')) {
                            completed = cardTitleLine.startsWith('[x] ');
                            title = cardTitleLine.substring(4).trim();
                        }

                        currentCard = {
                            title,
                            content: '',
                            completed,
                            tags: [],
                            dueDate: null,
                            subtasks: []
                        };
                        if (currentColumn) {
                            currentColumn.cards.push(currentCard);
                        }
                    } else if (line.startsWith('标签:')) {
                        // 标签
                        const tagsText = line.substring(3).trim();
                        if (tagsText && currentCard) {
                            const tags = tagsText.split(', ').map(text => {
                                return { text, color: 'gray' }; // 默认颜色
                            });
                            currentCard.tags = tags;
                        }
                    } else if (line.startsWith('到期时间:')) {
                        // 到期时间
                        const dueDate = line.substring(5).trim();
                        if (currentCard) {
                            currentCard.dueDate = dueDate;
                        }
                    } else if (line.startsWith('- [ ] ') || line.startsWith('- [x] ')) {
                        // 子任务
                        const completed = line.startsWith('- [x] ');
                        const title = line.substring(6).trim();
                        if (currentCard) {
                            if (!currentCard.subtasks) {
                                currentCard.subtasks = [];
                            }
                            currentCard.subtasks.push({
                                title,
                                completed
                            });
                        }
                    } else if (line.trim() !== '---' && line.trim() !== '' && 
                            !line.startsWith('### 子任务') && 
                            !line.startsWith('<!--')) {
                        // 卡片内容（忽略分隔符和注释）
                        if (currentCard) {
                            if (currentCard.content.length > 0) {
                                currentCard.content += '\n' + line;
                            } else {
                                currentCard.content = line;
                            }
                        }
                    }
                });

                if (newData.length > 0) {
                    kanbanData = newData;
                    saveData();
                    renderKanban();
                } else {
                    showConfirmation('无法从文件中解析出有效的看板数据', () => {});
                }
            }

            // ==================== 初始化渲染 ====================
            // 添加滚动检测和优化
            function checkScrollability() {
                const container = document.getElementById('kanban-container');
                const columns = container.querySelectorAll('.column');
                const addColumn = container.querySelector('.add-column');
                
                if (columns.length + (addColumn ? 1 : 0) > 0) {
                    const totalWidth = Array.from(columns).reduce((sum, col) => sum + col.offsetWidth, 0) + 
                                    (addColumn ? addColumn.offsetWidth : 0) + 
                                    (columns.length * 15); // 加上gap
                    
                    if (totalWidth > container.offsetWidth) {
                        container.classList.add('scrollable');
                    } else {
                        container.classList.remove('scrollable');
                    }
                }
            }

            // 初始化时检查
            setTimeout(checkScrollability, 100);

            // 窗口大小变化时检查
            window.addEventListener('resize', checkScrollability);

            // 添加列时检查
            const originalAddColumnBtn = document.querySelector('#add-column-btn');
            if (originalAddColumnBtn) {
                const originalOnClick = originalAddColumnBtn.onclick;
                originalAddColumnBtn.onclick = function(e) {
                    if (originalOnClick) originalOnClick.call(this, e);
                    setTimeout(checkScrollability, 100);
                };
            }

            // 初始渲染
            renderKanban();
        });
    </script>
</body>
</html>